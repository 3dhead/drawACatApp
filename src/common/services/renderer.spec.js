/**
 * Created by Michael on 29/03/14.
 */

describe('renderer', function() {

    var startTime;
    var canvas;
    var renderer;

    beforeEach(module('drawACat'));
    beforeEach(function() {
        // need to mock the audioPlayer service as it gets called by the ballFactory and
        // has trouble finding the audio files when running in test environment.
        mockAudioPlayer = {
            ballBounceSoft: function () {
            },
            ballBounceHard : function() {
            }
        };
        module(function ($provide) {
            $provide.value('audioPlayer', mockAudioPlayer);
        });
    });
    beforeEach(inject(function(_renderer_) {
        canvas = document.createElement('CANVAS');
        canvas.width = 500;
        canvas.height= 500;
        document.body.appendChild(canvas);
        renderer = _renderer_.setCanvas(canvas);
        startTime = new Date().getTime();
    }));


    describe('renderCat() method', function() {
        var cat;
        beforeEach(inject(function(_serializer_) {
            // build a cat object
            cat = _serializer_.unserializeCat(angular.fromJson('{"head":{"part":{"path":[[[239,61],[233,60],[224,57],[220,56],[209,54],[200,53],[191,53],[182,53],[172,54],[166,54],[160,54],[150,55],[141,58],[135,60],[129,64],[124,66],[120,69]],[[128,73],[121,70],[117,66],[108,55],[100,46],[86,30],[78,21],[71,15],[65,14],[61,13],[55,14],[51,15],[46,18],[43,22],[41,27],[41,33],[43,39],[46,49],[48,62],[49,67],[50,72],[50,78],[50,83],[50,88],[50,94],[49,99],[49,105],[47,112],[45,117],[46,122],[46,129],[46,135],[46,141],[45,151],[45,156],[46,164],[46,177],[49,184],[50,188],[53,197],[56,202],[60,208],[63,213],[68,218],[74,223],[82,229],[89,234],[97,238],[102,241],[110,244],[117,246],[123,249],[131,253],[135,256],[143,260],[148,262],[157,266],[164,268],[170,270],[175,272],[186,271],[192,271],[202,269],[210,265],[215,262],[220,259],[226,253],[231,252],[236,247],[242,244],[248,242],[253,239],[258,237],[264,232],[270,228],[274,225],[279,220],[284,214],[288,209],[291,204],[294,196],[298,187],[300,181],[303,173],[304,166],[304,156],[304,149],[302,141],[300,134],[297,126],[295,120],[294,115],[294,108],[294,101],[294,95],[294,87],[294,81],[297,72],[298,65],[300,58],[303,52],[305,46],[306,40],[309,30],[311,24],[311,18],[312,12],[312,9],[308,4],[302,2],[293,1],[276,4],[266,10],[257,16],[251,21],[244,29],[239,38],[233,45],[228,52],[224,61],[220,66]],[[177,161],[173,166],[177,171],[183,171],[189,171],[193,169],[187,165],[182,164],[176,166]],[[224,176],[245,175],[297,187]],[[215,183],[228,187],[261,200],[299,229]],[[228,198],[256,232],[272,254]],[[136,173],[131,173],[114,172],[97,172],[66,183],[32,191]],[[131,185],[114,189],[92,194],[58,214]],[[133,198],[125,201],[103,211],[63,246]],[[290,33],[283,35],[274,40],[267,46],[262,51],[254,60],[249,67],[246,71],[254,68],[275,60],[291,54]],[[251,80],[261,78],[286,76]],[[67,40],[75,48],[85,59],[94,68],[98,74],[97,78],[82,73],[72,73]],[[92,84],[83,88]],[[128,94]],[[110,106],[101,105]],[[80,126],[72,129]],[[245,85]],[],[[280,131]],[[288,149]],[[260,108]],[],[[225,69],[219,61]],[[183,73]],[[167,75],[160,72]],[[116,89],[104,90]],[[59,131]],[[66,166]],[[179,180],[179,189]],[[155,175]],[[152,199]],[[146,186]],[],[[206,196]],[[211,185]],[],[]],"name":"head"},"behaviour":{"sensitivity":{"xOffset":-0.05,"yOffset":0,"xSkew":0.25,"ySkew":0.25,"rotation":0.1},"range":550}},"eyesOpen":{"part":{"path":[[[125,132],[124,137],[123,143],[123,148],[127,152],[132,149],[132,144],[128,141],[125,147],[125,151],[131,149],[131,144],[126,149],[128,153],[131,148],[128,147],[131,153]],[[234,132],[236,138],[236,144],[233,151],[236,152],[235,151]],[[237,150],[232,153],[228,149],[228,143],[231,144]],[[230,142],[234,147],[234,152],[234,152]],[[232,144],[234,150],[232,150]],[[236,145],[236,145]],[[238,144],[240,139]],[[123,130],[123,128],[130,123]],[[233,119],[237,126]]],"name":"eyesOpen","parentName":"head"},"behaviour":{"sensitivity":{"xOffset":0,"yOffset":0,"xSkew":0,"ySkew":0,"rotation":0},"range":100}},"eyesClosed":{"part":{"path":[[[139,149],[134,147],[128,143]],[[140,150],[134,150],[127,150],[122,150]],[[143,146],[137,144],[131,142],[125,140]],[[221,150],[228,146],[238,140],[243,138]],[[229,147],[236,149],[244,150]],[[225,147],[225,151],[234,147],[243,144]]],"name":"eyesClosed","parentName":"head"},"behaviour":{"sensitivity":{"xOffset":0,"yOffset":0,"xSkew":0,"ySkew":0,"rotation":0},"range":100}},"mouthOpen":{"part":{"path":[[[179,202],[175,206],[170,208],[166,213],[160,214],[155,214],[150,212],[146,211]],[[183,205],[190,210],[195,212],[202,213],[207,212],[212,210],[217,206]],[[155,224],[158,230],[161,235],[167,241],[173,244],[177,245],[182,247],[188,247],[192,245],[197,241],[201,235],[207,226],[209,223]],[[155,218],[158,223],[161,227],[164,223],[167,217]],[[202,214],[203,218],[204,224],[206,225],[212,217],[216,210]],[[169,239],[175,238],[181,238],[185,238],[190,241]]],"name":"mouthOpen","parentName":"head"},"behaviour":{"sensitivity":{"xOffset":0,"yOffset":0,"xSkew":0,"ySkew":0,"rotation":0},"range":100}},"mouthClosed":{"part":{"path":[[[149,216],[153,217],[159,218],[167,215],[173,212],[180,209],[185,214],[189,216],[195,216],[201,215],[209,211]],[[180,202],[179,208]],[[152,217],[152,223],[152,227],[158,224]],[[194,217],[195,223],[196,228],[199,226],[201,219]]],"name":"mouthClosed","parentName":"head"},"behaviour":{"sensitivity":{"xOffset":0,"yOffset":0,"xSkew":0,"ySkew":0,"rotation":0},"range":100}},"body":{"part":{"path":[[[127,235],[122,241],[116,246],[110,251],[104,259],[94,268],[88,274],[80,282],[74,292],[71,298],[61,315],[59,324],[58,328],[58,335],[58,341],[58,347]],[[92,351],[86,349],[82,344],[76,342],[71,338],[64,337],[60,335],[55,335],[49,335],[39,338],[32,343],[28,348],[25,353],[19,366],[18,377],[18,384],[19,392],[19,398],[24,410],[27,415],[31,421],[37,428],[41,433],[42,437],[40,442],[36,447],[30,452],[24,456],[12,466],[6,470],[2,475]],[[233,234],[238,241],[243,245],[252,256],[266,271],[273,284],[276,291],[280,298],[285,307],[286,311],[288,318],[288,322],[288,326]],[[264,336],[271,333],[279,332],[285,329],[293,330],[301,331],[312,335],[317,341],[321,345],[326,355],[328,362],[329,370],[329,375],[326,386],[324,393],[321,404],[316,410],[314,415],[309,422],[307,426],[306,431],[306,436],[307,442],[310,447],[314,452],[320,457],[325,461],[330,464]],[[126,345]],[[123,331],[131,336]],[[131,308],[137,316]],[[148,301]],[[162,293]],[[173,292],[174,298]],[[200,288],[200,296]],[[215,293],[214,299]],[[223,308]],[[240,317],[238,323]],[[253,321],[249,326]],[[255,352],[254,360]],[[261,384]],[],[[258,412]],[[257,426]],[[119,357],[121,362]],[[113,388]],[[104,398],[107,407]],[],[[113,437]],[[285,301],[287,295],[288,290],[291,282],[295,273],[299,267],[303,261],[308,256],[312,249],[317,244],[322,238],[328,231],[335,226],[339,222],[350,217],[356,214],[362,212],[367,212],[373,214],[378,214],[388,218],[396,223],[403,231],[406,235],[412,242],[418,251],[421,258],[425,266],[427,272],[428,277],[429,282],[428,286],[422,286],[417,283],[413,285],[415,290],[415,295],[415,301],[415,305],[411,302],[412,308],[412,313],[406,313],[403,307],[400,304],[394,301],[392,306],[385,305],[369,289],[360,283],[356,282],[351,283],[345,285],[338,289],[333,293],[327,298],[322,307],[321,313],[319,319],[316,326]],[[385,307],[391,313],[398,321],[402,326],[407,330],[412,335],[417,332],[421,324],[425,317],[428,308],[434,280]],[[376,283]],[[388,274]],[[392,262]],[[397,250]],[[351,274],[361,267]],[[336,268]],[[346,253]],[[385,293]],[],[],[],[[322,298]],[[314,323],[320,307],[329,283]],[[325,299],[336,286]],[[351,281]],[[365,282],[374,278]],[[389,277]],[[389,286],[404,283]],[[401,299]],[[390,300],[407,312]],[[386,295],[403,307]],[[406,278]],[[360,272]],[],[[89,327],[82,326]],[[107,310],[101,308]],[[108,289],[100,295]],[[65,326]],[[118,276]],[],[[250,302]],[[276,320]],[[248,283]],[[231,267]],[],[[135,284]],[[120,268]],[[91,295],[86,304]],[[92,290]],[[113,276],[107,280],[100,286]],[[70,310],[66,319]],[],[[100,329]],[[114,295],[104,299],[95,305]],[[77,329]],[[220,282]],[[251,274],[257,275]],[[279,293]],[],[[271,315],[298,328]],[[35,373],[34,386],[40,401]],[[28,390],[40,408]],[[25,398],[34,414],[42,430]],[[48,401],[53,413],[64,432]],[[62,396]],[[67,406],[74,428]],[[52,446],[46,452]],[[64,448],[56,452],[32,475]],[[297,361],[306,369],[317,388]],[[329,376],[326,386],[324,396]],[[291,376],[294,383],[294,401],[293,412]],[[295,383],[294,392],[292,402]],[[315,396],[313,401],[309,417]],[[303,436],[314,444],[326,452]],[[303,446],[309,453]],[[288,440]]],"name":"body"},"behaviour":{"sensitivity":{"xOffset":-0.01,"yOffset":-0.02,"xSkew":0.01,"ySkew":0.05,"rotation":0},"range":300}},"leftLeg":{"part":{"path":[[[89,319],[92,324],[95,329],[98,335],[98,341],[99,347],[100,355],[100,361],[99,368],[99,374],[99,381],[99,386],[99,392],[100,401],[101,409],[101,413],[102,421],[102,426],[103,432],[104,437],[105,442],[108,446],[113,452],[117,455],[122,460],[126,462],[132,465],[138,465],[144,464],[152,462],[157,460],[162,456],[164,452],[164,446],[161,442],[156,437],[151,434],[149,430],[147,425],[147,415],[147,405],[147,397],[147,390],[147,385],[147,381],[147,375],[147,370],[148,365],[148,360],[148,355],[148,351],[148,347],[148,342]],[[137,461],[140,467]],[[152,457],[161,461]],[[154,457]]],"name":"leftLeg"},"behaviour":{"sensitivity":{"xOffset":0.6,"yOffset":0.6,"xSkew":0.2,"ySkew":0.4,"rotation":0.4},"range":200}},"rightLeg":{"part":{"path":[[[212,340],[214,350],[215,356],[218,370],[220,381],[221,386],[219,396],[218,401],[215,408],[214,413],[211,418],[209,422],[205,427],[203,432],[200,437],[200,442],[200,447],[200,452],[201,458],[206,462],[211,464],[216,465],[221,464],[227,463],[231,461],[236,458],[241,453],[245,449],[248,442],[249,437],[252,431],[253,425],[255,419],[255,414],[256,408],[257,402],[258,398],[258,392],[259,388],[259,383],[259,379],[259,372],[259,367],[259,362],[260,357],[260,353],[261,346],[262,342],[265,337]],[],[[199,451]],[[202,449]],[[209,461]]],"name":"rightLeg"},"behaviour":{"sensitivity":{"xOffset":0.6,"yOffset":0.6,"xSkew":0.2,"ySkew":0.4,"rotation":0.4},"range":200}}}'));
        }));

        xit('should render cat above 60fps', function() {
            var TIMES = 100;
            for (var i = 1; i < TIMES; i ++) {
                renderer.renderCat(cat);
            }
            var endTime= new Date().getTime();
            var executionTime = endTime - startTime;
            var fps = TIMES / executionTime * 1000;
            console.log('renderCat execution time: ' + executionTime + 'ms or ' + fps + ' fps');
            expect(fps).toBeGreaterThan(60);
        });
    });

    describe('renderBall() method', function() {
        var ball;

        beforeEach(inject(function(Ball) {
            ball = new Ball(25, 'http://192.168.0.10/GitHub/drawACatApp/build/assets/images/ball01.gif');
            ball.setY(100);
        }));

        xit('should render ball above 60fps', function() {
            var TIMES = 100;
            var angle = 0;
            for (var i = 1; i < TIMES; i ++) {
                ball.setAngle(angle);
                renderer.renderBall(ball);
                angle += 0.1;
            }
            var endTime= new Date().getTime();
            var executionTime = endTime - startTime;
            var fps = TIMES / executionTime * 1000;
            console.log('renderBall execution time: ' + executionTime + 'ms or ' + fps + ' fps');
            expect(fps).toBeGreaterThan(60);
        });
    });

});